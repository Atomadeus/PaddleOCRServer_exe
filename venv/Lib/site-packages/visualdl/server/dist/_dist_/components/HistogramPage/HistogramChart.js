import et from"../LineChart.js";import{Modes as a,options as rt}from"../../resource/histogram/index.js";import o,{useCallback as F,useEffect as nt,useMemo as m,useRef as ot,useState as X}from"../../../__snowpack__/pkg/react.js";import it from"../StackChart.js";import{rem as h,size as Z}from"../../utils/style.js";import E from"../Chart.js";import{Chart as q}from"../Loader/ChartPage.js";import at from"../ChartToolbox.js";import{distance as st}from"../../utils/index.js";import{format as N}from"../../../__snowpack__/pkg/d3-format.js";import lt from"../../../__snowpack__/pkg/lodash/minBy.js";import mt from"../../../__snowpack__/pkg/query-string.js";import p from"../../../__snowpack__/pkg/styled-components.js";import{useRunningRequest as ct}from"../../hooks/useRequest.js";import ut from"../../hooks/useThrottleFn.js";import{useTranslation as ht}from"../../../__snowpack__/pkg/react-i18next.js";import pt from"../../hooks/useWebAssembly.js";const Y=N(".4f"),M=N(".4"),gt=p.div`
    ${Z("100%","100%")}
    display: flex;
    flex-direction: column;
    align-items: stretch;
    justify-content: space-between;
`,ft=p(et)`
    flex-grow: 1;
`,xt=p(it)`
    flex-grow: 1;
`,yt=p(at)`
    margin-left: ${h(20)};
    margin-right: ${h(20)};
    margin-bottom: ${h(18)};
`,_t=p.div`
    ${Z("100%","100%")}
    display: flex;
    justify-content: center;
    align-items: center;
`,u={width:430,height:337},O={width:h(u.width),height:h(u.height)},dt=({run:s,tag:x,mode:r,running:V})=>{const{t:c}=ht(["histogram","common"]),y=ot(null),{data:g,error:W,loading:_}=ct(`/histogram/list?${mt.stringify({run:s.label,tag:x})}`,!!V,{refreshInterval:60*1e3}),[B,H]=X(!1),d=m(()=>`${x} (${s.label})`,[x,s.label]),G=m(()=>[g!=null?g:[],r],[g,r]),{data:n}=pt("histogram_transform",G),[l,k]=X(null);nt(()=>k(null),[r]);const w=m(()=>{var e;if(r===a.Overlay)return n==null?void 0:n.data.map((t,i)=>({name:`${c("common:time-mode.step")}${t[0][1]}`,data:t,lineStyle:{color:s.colors[i===l||l==null?0:1]},z:i===l?n==null?void 0:n.data.length:i,encode:{x:[2],y:[3]}}));if(r===a.Offset){const t=n;return{minX:t==null?void 0:t.minX,maxX:t==null?void 0:t.maxX,minY:t==null?void 0:t.minStep,maxY:t==null?void 0:t.maxStep,minZ:t==null?void 0:t.minZ,maxZ:t==null?void 0:t.maxZ,data:(e=t==null?void 0:t.data)!=null?e:[]}}return null},[n,r,s,l,c]),S=m(()=>({[a.Overlay]:e=>{var i;if(!n||l==null)return"";const t=e.find(f=>f.data[1]===n.data[l][0][1]);return(i=t==null?void 0:t.seriesName)!=null?i:""},[a.Offset]:e=>e[2]}),[l,n]),T=m(()=>({[a.Overlay]:e=>e.axisDimension==="x"?Y(e.value):e.axisDimension==="y"?M(e.value):"",[a.Offset]:(e,t)=>e.axisDimension==="x"?Y(t==null?void 0:t[0]):e.axisDimension==="y"?M(t==null?void 0:t[1]):""}),[]),j=m(()=>({...rt[r],color:[s.colors[0]],tooltip:{formatter:S[r]},axisPointer:{label:{formatter:T[r]}},xAxis:{axisPointer:{snap:r===a.Overlay},splitLine:{show:!1}},yAxis:{axisPointer:{snap:r===a.Overlay}}}),[r,s,S,T]),J=F((e,{offsetX:t,offsetY:i})=>{var I;const f=e.getOption().series,Q=[t,i];if(f){const U=f.map((b,$)=>{var L;return(L=b.data)==null?void 0:L.reduce((P,[,,R,A])=>{const tt=e.convertToPixel("grid",[R,A]),D=st(tt,Q);return D<P[2]?[R,A,D,$]:P},[0,0,Number.POSITIVE_INFINITY,$])}),C=lt(U,b=>b[2]);k((I=C==null?void 0:C[3])!=null?I:null);return}},[]),v=ut(J,{wait:200}),z=F(e=>{const t=e.getZr();t&&(t.on("mousemove",i=>v.run(e,i)),t.on("mouseout",()=>{v.cancel(),k(null)}))},[v]),K=m(()=>r===a.Overlay?o.createElement(ft,{ref:y,title:d,data:w,options:j,loading:_,onInit:z}):r===a.Offset?o.createElement(xt,{ref:y,title:d,data:w,options:j,loading:_}):null,[w,_,r,j,d,z]);return!n&&W?o.createElement(_t,null,c("common:error")):o.createElement(E,{maximized:B,...O},o.createElement(gt,null,K,o.createElement(yt,{items:[{icon:"maximize",activeIcon:"minimize",tooltip:c("common:maximize"),activeTooltip:c("common:minimize"),toggle:!0,onClick:()=>H(e=>!e)},{icon:"download",tooltip:c("common:download-image"),onClick:()=>{var e;return(e=y.current)==null?void 0:e.saveAsImage()}}]})))};export default dt;export const Loader=()=>o.createElement(o.Fragment,null,o.createElement(E,{...O},o.createElement(q,{width:u.width-2,height:u.height-2})),o.createElement(E,{...O},o.createElement(q,{width:u.width-2,height:u.height-2})));
