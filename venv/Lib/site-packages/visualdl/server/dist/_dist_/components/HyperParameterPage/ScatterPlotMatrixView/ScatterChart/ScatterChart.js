import*as a from"../../../../../__snowpack__/pkg/d3.js";import S from"../../../../../__snowpack__/pkg/eventemitter3.js";import{ScaleMethod as b}from"../../../../resource/hyper-parameter/index.js";import w from"../../../../../__snowpack__/pkg/lodash/intersection.js";const M=2,T=4,O=5,A="#000",k=2,D=class extends S{constructor(t,e){super();var p,o,i,s;this.labelVisible=[!0,!0],this.scale=[a.scaleLinear(),a.scaleLinear()],this.axis=[a.axisTop(a.scaleLinear()),a.axisRight(a.scaleLinear())],this.grid=[a.axisTop(a.scaleLinear()),a.axisRight(a.scaleLinear())],this.label=[a.axisBottom(a.scaleLinear()),a.axisLeft(a.scaleLinear())],this.brush=a.brush(),this.dots=[],this.hoverDots=[],this.data=[],this.type=["continuous","continuous"],this.colors=[],this.scaleMethod=[null,null],this.hoveredIndex=null,this.selectedIndex=null,this.brushedIndexes=null,this.brushing=!1,this.container=t,this.width=(p=e==null?void 0:e.width)!=null?p:150,this.height=(o=e==null?void 0:e.height)!=null?o:150,this.colors=(i=e==null?void 0:e.colors)!=null?i:[],this.labelVisible=(s=e==null?void 0:e.labelVisible)!=null?s:[!0,!0];const{left:l,right:r,top:d,bottom:u}=this.margin,m=this.width+l+r,f=this.height+d+u;this.svg=a.select(t).append("svg").attr("width",m).attr("height",f).attr("viewBox",`0 0 ${m} ${f}`).on("click",()=>this.select(null)),this.init()}get margin(){const{MARGIN_WITHOUT_LABEL:t,MARGIN_LEFT_WITH_LABEL:e,MARGIN_BOTTOM_WITH_LABEL:l}=D;return{top:t,right:t,left:this.labelVisible[1]?e:t,bottom:this.labelVisible[0]?l:t}}get ticks(){return[this.scaleMethod[0]===b.LOGARITHMIC?k:this.width/30,this.scaleMethod[1]===b.LOGARITHMIC?k:this.height/20].map(Math.floor)}init(){this.svg.append("g").classed("axises",!0).call(l=>l.append("g").classed("x-grid",!0)).call(l=>l.append("g").classed("y-grid",!0)).call(l=>l.append("g").classed("x-axis",!0)).call(l=>l.append("g").classed("y-axis",!0)).call(l=>l.append("g").classed("x-label",!0)).call(l=>l.append("g").classed("y-label",!0));const{left:t,top:e}=this.margin;this.brush=a.brush().extent([[t-.5,e-.5],[this.width+t+.5,this.height+e+.5]]).on("start",()=>this.brushing=!0).on("brush",({selection:l})=>this.brushed(l)).on("end",({selection:l})=>{this.brushed(l),this.brushing=!1}),this.svg.call(l=>l.append("g").classed("dots",!0)).call(l=>l.append("g").classed("brush",!0).call(this.brush)).call(l=>l.append("g").classed("select-dots",!0)).call(l=>l.append("g").classed("hover-dots",!0))}createScale(t,e){return t==="continuous"?e===b.QUANTILE?a.scaleQuantile():e===b.LOGARITHMIC?a.scaleLog():a.scaleLinear():a.scalePoint().padding(.5)}scaleDots(){this.dots.forEach((t,e)=>{t.attr("r",e===this.hoveredIndex||e===this.selectedIndex?T:M)})}colorizeDots(){var t;this.dots.forEach((e,l)=>{var d;const r=this.brushedIndexes!=null&&!this.brushedIndexes.includes(l);e.classed("disabled",r).attr("stroke","none"),r?e.attr("fill",null):e.attr("fill",(d=this.colors[l])!=null?d:A)}),this.hoverDots.forEach((e,l)=>e.classed("disabled",this.brushedIndexes!=null&&!this.brushedIndexes.includes(l))),this.selectedIndex!=null&&this.svg.selectAll(".select-dots circle").attr("stroke",(t=this.colors[this.selectedIndex])!=null?t:A)}drawSelectedDot(){const t=this.svg.select(".select-dots");t.selectAll("*").remove(),this.dots.forEach((e,l)=>{if(l===this.selectedIndex){const r=e.attr("cx"),d=e.attr("cy"),u=e.attr("fill");t.append("circle").attr("cx",r).attr("cy",d).attr("r",O).attr("fill","none").attr("stroke",u).attr("stroke-width",1)}})}draw(){this.scale=this.scale.map((i,s)=>this.createScale(this.type[s],this.scaleMethod[s]));const{left:t,top:e}=this.margin,l=this.type.map((i,s)=>{const h=this.data.map(n=>n[s]);return i!=="continuous"?[...new Set(h)]:a.extent(h)}),r=[[t,this.width+t],[this.height+e,e]];this.scaleMethod.forEach((i,s)=>{if(i===b.QUANTILE){const h=this.ticks[s],n=(r[s][1]-r[s][0])/(h-1);r[s]=a.range(h).map(c=>r[s][0]+n*c)}}),this.scale.forEach((i,s)=>{i.domain(l[s]).range(r[s])}),[this.axis,this.grid,this.label].forEach(i=>{i.forEach((s,h)=>{s.scale(this.scale[h]),this.scaleMethod[h]===b.QUANTILE?s.tickValues(this.scale[h].quantiles()).tickFormat(a.format("-.2g")):(s.tickValues(null).tickFormat(null),this.type[h]==="continuous"&&s.ticks(this.ticks[h]))})}),this.grid[0].tickSize(this.height),this.grid[1].tickSize(this.width);const d=[this.svg.select(".x-axis"),this.svg.select(".y-axis")],u=[this.svg.select(".x-grid"),this.svg.select(".y-grid")],m=[this.svg.select(".x-label"),this.svg.select(".y-label")];[d,u,m].forEach(i=>{i[0].attr("transform",`translate(0, ${this.height+e})`).call(s=>s.selectAll("*").remove()),i[1].attr("transform",`translate(${t}, 0)`).call(s=>s.selectAll("*").remove())}),d.forEach((i,s)=>i.call(this.axis[s]).selectAll(".tick text").remove()),u.forEach((i,s)=>i.call(this.grid[s]).call(h=>h.selectAll(".tick text").remove()).call(h=>h.select(".domain").remove())),m.forEach((i,s)=>{this.labelVisible[s]&&i.call(this.label[s]).call(h=>h.selectAll(".tick line").remove()).call(h=>h.select(".domain").remove())});const f=this.svg.select(".dots"),p=this.svg.select(".hover-dots"),o=this.svg.select(".select-dots");f.selectAll("*").remove(),p.selectAll("*").remove(),o.selectAll("*").remove(),this.dots=[],this.hoverDots=[],this.data.forEach((i,s)=>{var v,x,I;const h=(v=this.scale[0](i[0]))!=null?v:0,n=(x=this.scale[1](i[1]))!=null?x:0,c=f.append("circle").attr("cx",h).attr("cy",n).attr("r",M).attr("fill",(I=this.colors[s])!=null?I:A),g=p.append("circle").attr("cx",h).attr("cy",n).attr("r",T).attr("fill","transparent").on("mouseenter",()=>{c.classed("disabled")||this.brushing||this.hover(s)}).on("mouseleave",()=>{c.classed("disabled")||this.brushing||this.hover(null)}).on("click",L=>{c.classed("disabled")||this.brushing||(this.select(s),L.stopPropagation())});this.dots.push(c),this.hoverDots.push(g)})}dataInSelection(t,[e,l]){const r=t===1?"y":"x",d=this.scaleMethod[t],u=this.scale[t],m=this.type[t],[f,p]=e<l?[e,l]:[l,e];if(m==="continuous"){let o,i;if(d===b.QUANTILE){const s=u,h=s.range(),n=h.filter(c=>f<=c&&c<=p).map(c=>{const g=s.invertExtent(c);return c===h[h.length-1]?[g[0],g[1]+1]:g});[o,i]=a.extent(a.merge(n))}else{const s=u.invert;o=s(f),i=s(p)}return r==="y"&&([o,i]=[i,o]),this.data.reduce((s,h,n)=>(h[t]>=o&&h[t]<=i&&s.push(n),s),[])}else{const o=u,i=o.domain(),s=o.step(),h=o.padding()*s,n=r==="x"?this.margin.left:this.margin.top;let c=(f-n-h)/s,g=(p-n-h)/s;r==="y"&&([c,g]=[g,c]);let v,x;return r==="x"?(v=Math.max(Math.floor(c)+1,0),x=Math.min(Math.ceil(g)-1,i.length-1)):(v=i.length-Math.min(Math.floor(c),i.length-1)-1,x=i.length-Math.max(Math.ceil(g),0)-1),this.data.reduce((I,L,y)=>{const E=i.indexOf(L[t]);return E>=v&&E<=x&&I.push(y),I},[])}}brushed(t){this.select(null);let e=null;t&&(e=w(...t.map((l,r)=>this.dataInSelection(r,[t[0][r],t[1][r]])))),this.clearableBrush(e),this.emit("brush",e)}clearableBrush(t,e=!1){e&&this.brush.clear(this.svg.select(".brush")),this.brushedIndexes=t,this.colorizeDots()}focus(t){this.clearableBrush(t,!0)}hover(t){t!==this.hoveredIndex&&(this.hoveredIndex=t,this.scaleDots(),this.emit("hover",t))}select(t){this.selectedIndex=t,this.scaleDots(),this.drawSelectedDot(),this.emit("select",t)}setColors(t){this.colors=t,this.colorizeDots(),this.drawSelectedDot()}setScaleMethod(t){this.scaleMethod=t,this.brushedIndexes=null,this.brush.clear(this.svg.select(".brush")),this.draw(),this.colorizeDots(),this.scaleDots()}render(t,e){this.hoveredIndex=null,this.selectedIndex=null,this.data=t,this.type=e,this.colors=[],this.draw()}dispose(){this.svg.remove()}};let _=D;_.MARGIN_WITHOUT_LABEL=8,_.MARGIN_LEFT_WITH_LABEL=50,_.MARGIN_BOTTOM_WITH_LABEL=30;export default _;
