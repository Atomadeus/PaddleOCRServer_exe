import*as nt from"../utils/chart.js";import _,{useCallback as d,useEffect as L,useImperativeHandle as xt,useMemo as X,useRef as W,useState as H}from"../../__snowpack__/pkg/react.js";import{primaryColor as vt,transitionProps as kt}from"../utils/style.js";import _t,{Wrapper as bt,useChartTheme as Pt}from"../hooks/useECharts.js";import Tt from"../../__snowpack__/pkg/react-spinners/GridLoader.js";import jt from"../../__snowpack__/pkg/lodash/defaultsDeep.js";import zt from"../../__snowpack__/pkg/styled-components.js";import Dt from"../hooks/useThrottleFn.js";const Et=zt.div`
    position: absolute;
    z-index: 1;
    background-color: var(--tooltip-background-color);
    color: var(--tooltip-text-color);
    border-radius: 4px;
    padding: 5px;
    display: none;
    ${kt(["color","background-color"])}
`,Lt=_.forwardRef(({options:b,data:Y,title:P,loading:it,zoom:lt,className:at,onInit:O},ct)=>{var ot;const{minZ:A,maxZ:G,minY:p,maxY:h,minX:q,maxX:B,...J}=Y!=null?Y:{minZ:0,maxZ:0,minY:0,maxY:0,minX:0,maxX:0,data:null},g=X(()=>{var t;return(t=J.data)!=null?t:[]},[J.data]),y=X(()=>p===0&&h===0?-.4:p-(h-p)*.4,[p,h]),x=d((t,e,i,r)=>{const o=r([t,e]);return o?(o[1]-=(i-A)/(G-A)*(r([0,p])[1]-r([0,y])[1]),o):[0,0]},[A,G,p,y]),$=d((t,e,i)=>{const r=[];let o=0;for(;g[t]&&o<g[t].length;){const s=e(o++),c=e(o++),u=e(o++);u!==1&&o===3&&r.push(x(s,c,1,i)),r.push(x(s,c,u,i)),u!==1&&o===g[t].length&&r.push(x(s,c,1,i))}return r},[x,g]),K=d((t,e)=>{var r,o;const i=$(t.dataIndex,e.value,e.coord);return{type:"polygon",silent:!0,z:(r=e.value)==null?void 0:r.call(e,1),shape:{points:i},style:(o=e.style)==null?void 0:o.call(e,{stroke:nt.xAxis.axisLine.lineStyle.color,lineWidth:1})}},[$]),[f,Q]=H(null),[v,I]=H([]),m=W(null),[pt,U]=H(""),N=W(f),V=W(v);L(()=>{N.current=f},[f]),L(()=>{V.current=v},[v]);const Z=b==null?void 0:b.axisPointer,T=(ot=Z==null?void 0:Z.label)==null?void 0:ot.formatter,tt=d(t=>!T||N.current==null?"":typeof T=="string"?T:T(t,V.current[N.current]),[T]),et=Pt(),l=X(()=>{const{color:t,colorAlt:e,toolbox:i,series:r,...o}=nt;return jt({title:{text:P!=null?P:""},visualMap:{min:p,max:h},axisPointer:{label:{formatter:tt}},xAxis:{min:q,max:B,axisPointer:{type:"none"}},yAxis:{inverse:!0,position:"right",min:y,max:h,axisLine:{onZero:!1},axisLabel:{formatter:s=>s<p?"":s+""},axisPointer:{type:"none"}},grid:{left:o.grid.right,right:o.grid.left},tooltip:{trigger:"none",showContent:!1,axisPointer:{axis:"y",snap:!1}},series:[{...r,type:"custom",silent:!0,data:g,renderItem:K}]},b,et,o)},[b,P,et,g,q,B,p,h,y,K,tt]),j=d(()=>{var t;Q(null),I([]),((t=l.tooltip)==null?void 0:t.formatter)&&(U(""),m.current&&(m.current.style.display="none"))},[l.tooltip]),ut=d((t,e)=>{var i,r,o,s,c;try{if(!t||!e)return;const{offsetX:u,offsetY:k}=e;if(k<y+((i=l==null?void 0:l.grid)==null?void 0:i.top)){j();return}const[gt,yt]=t.convertFromPixel("grid",[u,k]),w=(r=t.getOption().series[0].data)!=null?r:[],C=w.map(a=>a[1]).sort((a,D)=>a-D);let M=0,z=null;for(;M<C.length;)if(yt<=C[M++]){z=C[M-1];break}const S=z==null?null:w.findIndex(a=>a[1]===z);Q(S);let R=[];z==null||(R=w.map(a=>{const D=[a[0],a[1],a[2]];let rt=Number.POSITIVE_INFINITY;for(let E=0;E<a.length;E+=3){const st=Math.abs(a[E]-gt);st<rt&&(rt=st,D[0]=a[E],D[2]=a[E+2])}return D})),I(R),((o=l.tooltip)==null?void 0:o.formatter)&&(U(S==null?"":(c=(s=l.tooltip)==null?void 0:s.formatter)==null?void 0:c.call(s,R[S])),m.current&&(z==null?m.current.style.display="none":(m.current.style.left=`${u+10}px`,m.current.style.top=`${k+10}px`,m.current.style.display="block")))}catch{j()}},[j,y,l.grid,l.tooltip]),F=Dt(ut,{wait:200}),mt=d(t=>{try{const e=t.getZr();e&&(e.on("mousemove",i=>F.run(t,i)),e.on("mouseout",()=>{F.cancel(),j()}))}catch{F.cancel()}O==null||O(t)},[O,F,j]),{ref:ft,echart:n,wrapper:dt,saveAsImage:ht}=_t({loading:!!it,zoom:lt,autoFit:!0,onInit:mt});return xt(ct,()=>({saveAsImage:()=>{ht(P)}})),L(()=>{n==null||n.setOption(l,{notMerge:!0})},[n,l]),L(()=>{var t,e;if(n)try{if(f==null)n.setOption({graphic:{elements:[{id:"highlight",type:"polyline",$action:"remove"}]}});else{const r=(e=(t=n.getOption().series[0])==null?void 0:t.data)!=null?e:[],o=c=>n.convertToPixel("grid",c),s=c=>r[f][c];n.setOption({graphic:{elements:[{id:"highlight",type:"polyline",$action:"replace",silent:!0,cursor:"default",zlevel:1,z:1,shape:{points:$(f,s,o)}}]}})}}catch{}},[f,n,$]),L(()=>{var t,e,i,r;if(n)try{if(!v.length)n.setOption({graphic:{elements:(r=(i=(e=(t=n.getOption())==null?void 0:t.graphic)==null?void 0:e[0])==null?void 0:i.elements)==null?void 0:r.filter(o=>o.id.startsWith("dot")).map(o=>({id:o.id,type:"circle",$action:"remove"}))}});else{const o=s=>n.convertToPixel("grid",s);n.setOption({graphic:{elements:v.map((s,c)=>{var k;const u=x(s[0],s[1],s[2],o);return{type:"circle",id:`dot${c}`,$action:"replace",cursor:"default",zlevel:1,z:2,shape:{cx:u[0],cy:u[1],r:3},style:{fill:"#fff",stroke:(k=l.color)==null?void 0:k[0],lineWidth:2}}})}})}}catch{}},[v,n,l.color,x]),_.createElement(bt,{ref:dt,className:at},!n&&_.createElement("div",{className:"loading"},_.createElement(Tt,{color:vt,size:"10px"})),_.createElement("div",{className:"echarts",ref:ft}),_.createElement(Et,{className:"tooltip",ref:m,dangerouslySetInnerHTML:{__html:pt}}))});export default Lt;
