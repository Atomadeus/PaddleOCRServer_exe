import*as he from"../../../../__snowpack__/env.js";import e,{useCallback as V,useEffect as U,useState as c}from"../../../../__snowpack__/pkg/react.js";import K from"../../pieChart.js";import fe from"../../StackColumnChart.js";import Ee from"../../Trainchart.js";import{fetcher as h}from"../../../utils/fetch.js";import{asideWidth as xe,primaryColor as q,rem as l}from"../../../utils/style.js";import M from"../../../../__snowpack__/pkg/react-spinners/GridLoader.js";import N from"../../../../__snowpack__/pkg/styled-components.js";const P=he.SNOWPACK_PUBLIC_PATH;import{Configure as T,EchartPie as F,ArgumentOperation as C,ViewWrapper as be,ButtonsLeft as J,ButtonsRight as Q,RadioButtons as X,TableContent as Y,Title as ye,PieceContent as $e,color2 as Z}from"../../components.js";import Pe from"./Environment.js";import Ce from"./PerformanceContent.js";import w from"../../../assets/images/question-circle.svg.proxy.js";import{Popover as k}from"../../../../__snowpack__/pkg/antd.js";import{useTranslation as we}from"../../../../__snowpack__/pkg/react-i18next.js";import{Table as ee}from"../../../../__snowpack__/pkg/antd.js";import ke from"../../Icon.js";xe;const D=N(T)`
    .titleContent {
        margin-bottom: ${l(10)};
        position: relative;
    }
    .ant-tabs-centered > .ant-tabs-nav .ant-tabs-nav-wrap:not([class*='ant-tabs-nav-wrap-ping']) {
        justify-content: flex-start;
    }
    .ant-tabs-ink-bar {
        display: none;
    }
    .ant-tabs-top > .ant-tabs-nav,
    .ant-tabs-bottom > .ant-tabs-nav,
    .ant-tabs-top > div > .ant-tabs-nav,
    .ant-tabs-bottom > div > .ant-tabs-nav {
        margin-bottom: 0px;
        border: none;
    }
    .ant-tabs-tab.ant-tabs-tab-active .ant-tabs-tab-btn {
        color: #1527c2;
    }
    .ant-tabs-tab {
        padding: ${l(12)} 0px ${l(23)} 0;
    }
    .is_active {
        color: #ffffff;
        background: #2932e1;
        border: 1px solid rgba(41, 50, 225, 1);
    }
    .noGpu {
        border: 1px solid rgba(221, 221, 221, 1);
        border-radius: 0px ${l(4)} ${l(4)} 0px;
        color: #cccccc;
        cursor: not-allowed;
    }
    .postions {
        position: absolute;
        top: 42px;
        right: 0;
        z-index: 10;
    }
`,te=N(F)`
    border: 1px solid #dddddd;
    height: ${l(444)};
    padding: ${l(24)};
`,Ge=N(te)`
    height: ${l(366)};
`,Ie=({runs:s,views:G,workers:p,spans:d,units:o,descriptions:f})=>{const{t:n}=we(["profiler","common"]),[j,ae]=c(),[ne,ie]=c(),[g,oe]=c(),[u,L]=c(!0),[B,re]=c(),[I,le]=c(!1),[R,me]=c(),[S,z]=c(!0),[E,A]=c("cpu"),[x,O]=c("cpu"),[ce,se]=c(),[W,H]=c(!0),[pe,de]=c();U(()=>{z(!0),H(!0),s&&p&&d&&o&&(h(`/profiler/overview/environment?run=${s}&worker=${p}&span=${d}`).then(i=>{ae(i)}),h(`/profiler/overview/model_perspective?run=${s}&worker=${p}&span=${d}&time_unit=${o}`).then(i=>{const r=i,_=[],a=[],t={cpu:[],gpu:[]};if(r.gpu){L(!0);for(const m of r.gpu){const $={};for(const v of r.column_name)if(v!=="name"&&v!=="calls"){const ge="GPU"+v,ve=m;$[ge]=ve[v]}a.push($)}r.gpu.shift();for(const m of r.gpu)t.gpu.push({value:m.total_time,name:m.name,proportion:m.ratio})}else L(!1);r.cpu.forEach((m,$)=>{const v=m&&{...m,...a[$]};_.push(v)}),me(_),z(!1),r.cpu.shift();for(const m of r.cpu)t.cpu.push({value:m.total_time,name:m.name,proportion:m.ratio});oe(t)}),h(`/profiler/overview/userdefined_perspective?run=${s}&worker=${p}&span=${d}&time_unit=${o}`).then(i=>{const a=i.events.map(t=>({key:t.name,...t}));se(a),H(!1)}),h(`/profiler/overview/event_type_model_perspective?run=${s}&worker=${p}&span=${d}&time_unit=${o}`).then(i=>{ie(i)}))},[s,p,d,G,o]),U(()=>{s&&p&&d&&o&&h(`/profiler/overview/event_type_perspective?run=${s}&worker=${p}&span=${d}&device_type=${x}&time_unit=${o}`).then(i=>{re(i)})},[s,p,d,G,x,o]),U(()=>{s&&p&&d&&o&&h(`/profiler/overview/model_perspective_perstep?run=${s}&worker=${p}&span=${d}&device_type=${E}&time_unit=${o}`).then(i=>{de(i)})},[s,p,d,G,E,o]);const _e=V((i,r)=>{const _=[{title:n("stage"),dataIndex:"name",key:"name",width:100},{title:n("number-calls"),dataIndex:"calls",key:"calls",width:100,sorter:(a,t)=>a.calls-t.calls},{title:"CPU",children:[{title:n("total-time")+`(${i})`,dataIndex:"total_time",key:"total_time",width:150,sorter:(a,t)=>a.total_time-t.total_time},{title:n("average-time")+`(${i})`,dataIndex:"avg_time",key:"avg_time",width:150,sorter:(a,t)=>a.avg_time-t.avg_time},{title:n("longest-time")+`(${i})`,dataIndex:"max_time",key:"max_time",width:150,sorter:(a,t)=>a.max_time-t.max_time},{title:n("shortest-time")+`(${i})`,dataIndex:"min_time",key:"min_time",width:150,sorter:(a,t)=>a.min_time-t.min_time},{title:n("percentage")+"%",dataIndex:"ratio",key:"ratio",width:150,sorter:(a,t)=>a.ratio-t.ratio}]}];return r&&_.push({title:"GPU",children:[{title:n("total-time")+`(${i})`,dataIndex:"GPUtotal_time",key:"GPUtotal_time",width:150,sorter:(a,t)=>a.GPUtotal_time-t.GPUtotal_time},{title:n("average-time")+`(${i})`,dataIndex:"GPUavg_time",key:"GPUavg_time",width:150,sorter:(a,t)=>a.GPUavg_time-t.GPUavg_time},{title:n("longest-time")+`(${i})`,dataIndex:"GPUmax_time",key:"GPUmax_time",width:150,sorter:(a,t)=>a.GPUmax_time-t.GPUmax_time},{title:n("shortest-time")+`(${i})`,dataIndex:"GPUmin_time",key:"GPUmin_time",width:150,sorter:(a,t)=>a.GPUmin_time-t.GPUmin_time},{title:n("percentage")+"%",dataIndex:"GPUratio",key:"GPUratio",width:150,sorter:(a,t)=>a.GPUratio-t.GPUratio}]}),_},[n]),ue=V((i,r)=>{const _=[{title:n("stage"),dataIndex:"name",key:"name",width:100},{title:n("number-calls"),dataIndex:"calls",key:"calls",width:100,sorter:(a,t)=>a.calls-t.calls},{title:"CPU",children:[{title:n("total-time")+`(${i})`,dataIndex:"cpu_total_time",key:"cpu_total_time",width:150,sorter:(a,t)=>a.cpu_total_time-t.cpu_total_time},{title:n("average-time")+`(${i})`,dataIndex:"cpu_avg_time",key:"cpu_avg_time",width:150,sorter:(a,t)=>a.cpu_avg_time-t.cpu_avg_time},{title:n("longest-time")+`(${i})`,dataIndex:"cpu_max_time",key:"cpu_max_time",width:150,sorter:(a,t)=>a.cpu_max_time-t.cpu_max_time},{title:n("shortest-time")+`(${i})`,dataIndex:"cpu_min_time",key:"cpu_min_time",width:150,sorter:(a,t)=>a.cpu_min_time-t.cpu_min_time},{title:n("percentage")+"%",dataIndex:"cpu_ratio",key:"cpu_ratio",width:150,sorter:(a,t)=>a.cpu_ratio-t.cpu_ratio}]}];return r&&_.push({title:"GPU",children:[{title:n("total-time")+`(${i})`,dataIndex:"gpu_total_time",key:"gpu_total_time",width:150,sorter:(a,t)=>a.gpu_total_time-t.gpu_total_time},{title:n("average-time")+`(${i})`,dataIndex:"gpu_avg_time",key:"gpu_avg_time",width:150,sorter:(a,t)=>a.gpu_avg_time-t.gpu_avg_time},{title:n("longest-time")+`(${i})`,dataIndex:"gpu_max_time",key:"gpu_max_time",width:150,sorter:(a,t)=>a.gpu_max_time-t.gpu_max_time},{title:n("shortest-time")+`(${i})`,dataIndex:"gpu_min_time",key:"gpu_min_time",width:150,sorter:(a,t)=>a.gpu_min_time-t.gpu_min_time},{title:n("percentage")+"%",dataIndex:"gpu_ratio",key:"gpu_ratio",width:150,sorter:(a,t)=>a.gpu_ratio-t.gpu_ratio}]}),_},[n]),b=i=>(console.log("descriptions",f),e.createElement("div",{style:{width:l(700),color:"#333333",fontWeight:400},dangerouslySetInnerHTML:{__html:f?f[i]:""}})),y=i=>i.parentElement;return e.createElement(be,null,e.createElement(ye,null,n("profiler:Overview-view")),j&&e.createElement(Pe,{environment:j,hasGpu:u,descriptions:f?f.overview_environment:""}),e.createElement(T,null,e.createElement("div",{className:"titleContent"},e.createElement("div",{className:"titles"},e.createElement("div",null,n("profiler:time-consuming")),e.createElement(k,{content:b("overview_model_perspective"),getPopupContainer:y,placement:"right"},e.createElement(C,null,e.createElement("img",{src:P+w,alt:""}))))),e.createElement($e,null,e.createElement(F,{style:{paddingRight:`${l(0)}`,paddingTop:`${l(0)}`}},e.createElement("div",{className:"wraper",style:{borderRight:"1px solid #dddddd",marginRight:`${l(10)}`}},e.createElement(K,{className:"Content",data:g==null?void 0:g.cpu,isCpu:!0,color:Z,units:o})),e.createElement("div",{className:"wraper"},e.createElement(K,{className:"Content",data:g==null?void 0:g.gpu,isCpu:!1,color:Z,units:o}))),e.createElement("div",{className:"expendContent",onClick:()=>{le(!I)}},e.createElement("div",{className:"expendButton"},n("Expand-view")),e.createElement(ke,{type:I?"chevron-up":"chevron-down"})),I&&R?e.createElement(Y,null,S&&e.createElement("div",{className:"loading"},e.createElement(M,{color:q,size:"10px"})),!S&&e.createElement(ee,{columns:_e(o,u),dataSource:R,bordered:!0,size:"middle",pagination:!1,scroll:{x:"calc(700px + 50%)",y:440}})):null)),e.createElement(D,null,e.createElement("div",{className:"titleContent"},e.createElement("div",{className:"titles",style:{marginBottom:`${l(0)}`}},e.createElement("div",null,n("training-step-time")),e.createElement(k,{content:b("overview_model_perspective_perstep"),getPopupContainer:y,placement:"right"},e.createElement(C,null,e.createElement("img",{src:P+w,alt:""})))),e.createElement(X,null,e.createElement(J,{style:{borderRight:"none"},onClick:()=>{A("cpu")},className:E==="cpu"?"is_active":""},n("CPU-time")),e.createElement(Q,{className:u?E==="gpu"?"is_active":"":"noGpu",onClick:()=>{u&&A("gpu")}},n("GPU-time")))),e.createElement(te,null,e.createElement(Ee,{className:"Content",data:pe,units:o}))),e.createElement(D,null,e.createElement("div",{className:"titleContent"},e.createElement("div",{className:"title"},e.createElement("div",null,n("performance-consumption")),e.createElement(k,{content:b("overview_event_type_perspective"),placement:"right",getPopupContainer:y},e.createElement(C,null,e.createElement("img",{src:P+w,alt:""})))),e.createElement(X,{className:"postions"},e.createElement(J,{style:{borderRight:"none"},onClick:()=>{O("cpu")},className:x==="cpu"?"is_active":""},n("CPU-time")),e.createElement(Q,{className:u?x==="gpu"?"is_active":"":"noGpu",onClick:()=>{u&&O("gpu")}},n("GPU-time")))),B&&e.createElement(Ce,{units:o,performanceData:B})),e.createElement(T,null,e.createElement("div",{className:"titleContent"},e.createElement("div",{className:"titles"},e.createElement("div",null,n("consumption-distribution")),e.createElement(k,{content:b("overview_event_type_model_perspective"),placement:"right",getPopupContainer:y},e.createElement(C,null,e.createElement("img",{src:P+w,alt:""}))))),e.createElement(Ge,null,e.createElement(fe,{className:"Content",data:ne,units:o}))),e.createElement(D,{style:{marginBottom:`${l(20)}`}},e.createElement("div",{className:"titleContent"},e.createElement("div",{className:"title"},n("custom-events"))),e.createElement(Y,null,W&&e.createElement("div",{className:"loading"},e.createElement(M,{color:q,size:"10px"})),!W&&e.createElement(ee,{columns:ue(o,u),dataSource:ce,bordered:!0,size:"middle",pagination:!1,scroll:{x:"calc(700px + 50%)",y:240}}))))};export default Ie;
