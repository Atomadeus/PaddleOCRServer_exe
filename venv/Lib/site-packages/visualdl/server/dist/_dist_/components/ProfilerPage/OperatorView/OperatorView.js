import e,{useState as i,useEffect as C,useCallback as ae}from"../../../../__snowpack__/pkg/react.js";import oe from"../../Input.js";import re from"../../StackColumnChart2.js";import j from"../../pieChart.js";import{Radio as $}from"../../../../__snowpack__/pkg/antd.js";import le from"../../Icon.js";import{primaryColor as ne}from"../../../utils/style.js";import{asideWidth as ie,rem as _}from"../../../utils/style.js";import v from"../../../../__snowpack__/pkg/styled-components.js";import{useTranslation as se}from"../../../../__snowpack__/pkg/react-i18next.js";import{Table as ce}from"../../../../__snowpack__/pkg/antd.js";import pe from"../../../../__snowpack__/pkg/react-spinners/GridLoader.js";import{fetcher as k}from"../../../utils/fetch.js";import me from"../../searchInput2.js";import{Configure as T,EchartPie as D,ButtonsLeft as P,ButtonsRight as de,RadioButtons as G,color as S,Title as ue,Subtraction as L,ViewWrapper as _e,RadioContent as ge,TableContent as he,PieceContent as ve,FullWidthSelect as Ee}from"../../components.js";ie;const fe=v(oe)`
    width: 100%;
    height: 100%;
    border: 1px solid #e0e0e0;
    border-radius: 0;
    text-align: center;
`,Ce=v(ue)`
    border-bottom: none;
    margin-bottom: ${_(0)};
`,xe=v.div`
    display: flex;
    border-bottom: 1px solid #dddddd;
`,$e=v(ve)`
    .expandChart {
        position: relative;
        padding-top: ${_(0)};
        border-top: 1px solid #dddddd;
        .postions {
            position: absolute;
            top: 18px;
            z-index: 10;
        }
    }
`,ke=v(D)`
    height: ${_(366)};
    padding: ${_(24)};
    padding-bottom: ${_(10)};
`,ye=({runs:p,workers:m,spans:d,units:c})=>{const{t:a}=se(["profiler","common"]),[R,U]=i(),[B,A]=i(),[V,z]=i(),[y,b]=i(!0),[W,O]=i(),[E,N]=i(!0),[w,F]=i(!0),[x,H]=i(""),[f,q]=i(!1),[J,K]=i(),[g,M]=i("op_name"),[I,Q]=i(1),[u,h]=i(0);C(()=>{K([{label:a("By-operator-name"),value:"op_name"},{label:a("operator-shape"),value:"op_name_input_shape"}])},[a]),C(()=>{p&&m&&d&&k(`/profiler/operator/pie?run=${p}&worker=${m}&span=${d}&time_unit=${c}&topk=${u}`).then(o=>{const n=o,l=[],s=[];for(const t of n.cpu)l.push({value:t.total_time,name:t.name,proportion:t.ratio});if(n.gpu)for(const t of n.gpu)s.push({value:t.total_time,name:t.name,proportion:t.ratio});else F(!1);U(l),A(s)})},[p,m,d,u,c]),C(()=>{p&&m&&d&&(b(!0),k(`/profiler/operator/table?run=${p}&worker=${m}&span=${d}&time_unit=${c}&search_name=${x}&group_by=${g}`).then(o=>{const l=o.events.map(s=>g==="op_name_input_shape"?{key:s.name+s.input_shape,...s}:{key:s.name,...s});z(l),b(!1)}))},[p,m,d,x,g,c]),C(()=>{p&&m&&d&&k(`/profiler/operator/pie_expand?run=${p}&worker=${m}&device_type=${E?"cpu":"gpu"}&topk=${u}&time_unit=${c}&span=${d}`).then(n=>{O(n)})},[p,m,d,E,u,c]);const X=o=>{Q(o.target.value),o.target.value===1?h(0):o.target.value===2&&h(10)},Y=ae((o,n,l)=>{const s=[{title:a("operator"),dataIndex:"name",key:"name",render:t=>e.createElement("div",null,t),width:144},{title:a("call-volume"),dataIndex:"calls",key:"calls",width:80,sorter:(t,r)=>t.calls-r.calls},{title:"CPU",children:[{title:a("total-time")+`(${o})`,dataIndex:"cpu_total_time",width:130,key:"cpu_total_time",sorter:(t,r)=>t.cpu_total_time-r.cpu_total_time},{title:a("average-time")+`(${o})`,dataIndex:"cpu_avg_time",width:130,key:"cpu_avg_time",sorter:(t,r)=>t.cpu_avg_time-r.cpu_avg_time},{title:a("longest-time")+`(${o})`,dataIndex:"cpu_max_time",width:130,key:"cpu_max_time",sorter:(t,r)=>t.cpu_max_time-r.cpu_max_time},{title:a("shortest-time")+`(${o})`,dataIndex:"cpu_min_time",width:130,key:"cpu_min_time",sorter:(t,r)=>t.cpu_min_time-r.cpu_min_time},{title:a("percentage")+"%",dataIndex:"cpu_ratio",key:"cpu_ratio",width:130,sorter:(t,r)=>t.cpu_ratio-r.cpu_ratio}]}];return l==="op_name_input_shape"&&s.splice(1,0,{title:a("input-shape"),dataIndex:"input_shape",width:130,key:"input_shape",render:t=>(t==null?void 0:t.length)>0?t.map((r,te)=>e.createElement("div",{key:r+te},r)):e.createElement("div",null,"-")}),n&&s.push({title:"GPU",children:[{title:a("total-time")+`(${o})`,dataIndex:"gpu_total_time",width:130,key:"gpu_total_time",sorter:(t,r)=>t.gpu_total_time-r.gpu_total_time},{title:a("average-time")+`(${o})`,dataIndex:"gpu_avg_time",width:130,key:"gpu_avg_time",sorter:(t,r)=>t.gpu_avg_time-r.gpu_avg_time},{title:a("longest-time")+`(${o})`,dataIndex:"gpu_max_time",width:130,key:"gpu_max_time",sorter:(t,r)=>t.gpu_max_time-r.gpu_max_time},{title:a("shortest-time")+`(${o})`,dataIndex:"gpu_min_time",width:130,key:"gpu_min_time",sorter:(t,r)=>t.gpu_min_time-r.gpu_min_time},{title:a("percentage")+"%",dataIndex:"gpu_ratio",key:"gpu_ratio",sorter:(t,r)=>t.gpu_ratio-r.gpu_ratio}]}),s},[a]),Z=o=>{const n=o.charAt(0);let l=o;return l=l.replace(/[^\d.]/g,""),l=l.replace(/^\./g,""),l=l.replace(/\.{2,}/g,"."),l=l.replace(".","$#$").replace(/\./g,"").replace("$#$","."),n==="-"&&(l="-"+l),l},ee=o=>{const n=Z(o);console.log("tops",n),h(n||0)};return e.createElement(_e,null,e.createElement(xe,null,e.createElement(Ce,null,a("Operator-view")),e.createElement(ge,null,e.createElement($.Group,{onChange:X,value:I},e.createElement($,{value:1},a("show-all-operators")),e.createElement($,{value:2},a("show-Top-operators"))),I===2?e.createElement("div",{className:"AdditionContent"},e.createElement(L,{disable:!0,className:"Addition",onClick:()=>{const o=u+1;h(o)}},"+"),e.createElement("div",{className:"input_wrapper"},e.createElement(fe,{onChange:ee,value:u+""})),e.createElement(L,{disable:u>1,onClick:()=>{if(u>1){const o=u-1;h(o)}}},"-")):null)),e.createElement(T,{style:{marginTop:`${_(25)}`}},e.createElement("div",{className:"titleContent"},e.createElement("div",{className:"titles"},e.createElement("div",null,a("Time-profile")))),e.createElement($e,null,e.createElement(D,{style:{padding:`${_(0)}`,paddingLeft:`${_(0)}`}},e.createElement("div",{className:"wraper",style:{borderRight:"1px solid #dddddd"}},e.createElement(j,{className:"Content",data:R,isCpu:!0,color:S,units:c})),e.createElement("div",{className:"wraper"},e.createElement(j,{className:"Content",data:B,isCpu:!1,color:S,units:c}))),e.createElement("div",{className:`expendContent ${f?"is_expend":""}`,onClick:()=>{q(!f)}},e.createElement("div",{className:"expendButton"},a("stage-view")),e.createElement(le,{type:f?"chevron-up":"chevron-down"})),f?e.createElement("div",{className:"expandChart"},w?e.createElement(G,{className:"postions"},e.createElement(P,{style:{borderRight:"none"},onClick:()=>{N(!0)},className:E?"is_active":""},a("CPU-time")),e.createElement(de,{className:E?"":"is_active",onClick:()=>{N(!1)}},a("GPU-time"))):e.createElement(G,{className:"postions"},e.createElement(P,null,a("CPU-time"))),e.createElement(ke,null,e.createElement(re,{className:"Content",data:W,units:c}))):null)),e.createElement(T,null,e.createElement("div",{className:"titleContent",style:{marginBottom:_(15)}},e.createElement("div",{className:"title"},a("Time-details")),e.createElement("div",{className:"searchContent"},e.createElement("div",{className:"select_wrapper"},e.createElement(Ee,{list:J,value:g,onChange:M})),e.createElement("div",{className:"input_wrapper"},e.createElement(me,{className:"search-input",value:x,onChange:H,placeholder:a("Search-operator"),rounded:!0})))),e.createElement(he,null,y&&e.createElement("div",{className:"loading"},e.createElement(pe,{color:ne,size:"10px"})),!y&&e.createElement(ce,{columns:Y(c,w,g),dataSource:V,bordered:!0,size:"middle",scroll:{x:g==="op_name_input_shape"?"calc(700px + 63%)":"calc(700px + 35%)"}}))))};export default ye;
