import{actions as D,selectors as E}from"../store/index.js";import{color as T,colorAlt as Q}from"../utils/chart.js";import{useCallback as w,useEffect as f,useMemo as g,useReducer as W}from"../../__snowpack__/pkg/react.js";import{useDispatch as F,useSelector as G}from"../../__snowpack__/pkg/react-redux.js";import I from"../../__snowpack__/pkg/lodash/groupBy.js";import M from"../../__snowpack__/pkg/lodash/intersection.js";import O from"../../__snowpack__/pkg/lodash/intersectionBy.js";import P from"../../__snowpack__/pkg/lodash/uniq.js";import v from"./useQuery.js";import{useRunningRequest as z}from"./useRequest.js";import{useSWRConfig as H}from"../../__snowpack__/pkg/swr.js";var S;(function(s){s[s.initRuns=0]="initRuns",s[s.setRuns=1]="setRuns",s[s.setSelectedRuns=2]="setSelectedRuns",s[s.initTags=3]="initTags",s[s.setTags=4]="setTags",s[s.setSelectedTags=5]="setSelectedTags"})(S||(S={}));const b=(s,l)=>Object.entries(I(s.filter(e=>!!s.find(n=>n.label===e.label)).reduce((e,n)=>(l&&l[n.label]&&Array.prototype.push.apply(e,l[n.label].map(o=>({label:o,run:n}))),e),[]),e=>e.label)).map(([e,n])=>({label:e,runs:n.map(o=>o.run)})),J=s=>s==null?void 0:s.map((l,e)=>{const n=e%T.length;return{label:l,colors:[T[n],Q[n]]}}),K=(s,l)=>{switch(l.type){case 0:{const e=l.payload,n=e.length?M(e,s.globalRuns):s.globalRuns,o=n.length?n:e,u=J(e),i=u.filter(h=>o.includes(h.label)),d=b(i,s.initTags);return{...s,initRuns:e,globalRuns:o,runs:u,selectedRuns:i,tags:d,selectedTags:d}}case 1:{const e=l.payload,n=O(s.selectedRuns,e,u=>u.label),o=b(n,s.initTags);return{...s,runs:e,selectedRuns:n,tags:o,selectedTags:o}}case 2:{const e=l.payload,n=e.map(u=>u.label),o=b(e,s.initTags);return{...s,globalRuns:n,selectedRuns:e,tags:o,selectedTags:o}}case 3:{const e=l.payload,n=b(s.selectedRuns,e);return{...s,initTags:e,tags:n,selectedTags:n}}case 4:{const e=l.payload;return{...s,tags:e,selectedTags:e}}case 5:{const e=l.payload;return{...s,selectedTags:e}}default:throw new Error}},L=(s,l)=>{const e=v(),{data:n,loading:o,error:u}=z(`/${s}/tags`,l),{cache:i}=H();f(()=>()=>i.delete(`/${s}/tags`),[s,i]);const d=F(),h=g(()=>E.runs.getRunsByPage(s),[s]),q=G(h),m=g(()=>{var t;return(t=n==null?void 0:n.runs)!=null?t:[]},[n]),c=g(()=>n?m.reduce((t,r,R)=>{var _,k,j;return t[r]?t[r]=[...t[r],...(k=(_=n.tags)==null?void 0:_[R])!=null?k:[]]:t[r]=(j=n.tags[R])!=null?j:[],t},{}):{},[m,n]),[a,p]=W(K,{initRuns:[],globalRuns:q,runs:[],selectedRuns:[],initTags:{},tags:[],selectedTags:[]}),y=g(()=>e.runs?P(Array.isArray(e.runs)?e.runs:e.runs.split(",")):[],[e]),B=w(t=>p({type:2,payload:t}),[]),C=w(t=>p({type:5,payload:t}),[]);f(()=>p({type:0,payload:m||[]}),[m]),f(()=>p({type:3,payload:c||{}}),[c]),f(()=>{if(y.length){const t=a.runs.filter(r=>y.includes(r.label));p({type:2,payload:t.length?t:a.runs})}},[y,a.runs]),f(()=>{d(D.runs.setSelectedRuns(s,a.globalRuns))},[d,a.globalRuns,s]);const $=g(()=>a.tags.reduce((t,{runs:r,...R})=>(Array.prototype.push.apply(t,r.map(_=>({...R,run:_,id:`${R.label}-${_.label}`}))),t),[]),[a.tags]),x=g(()=>a.selectedRuns.filter(t=>{var r;return!!((r=c==null?void 0:c[t.label])==null?void 0:r.length)}),[a.selectedRuns,c]);return{...a,tagsWithSingleRun:$,runsInTags:x,onChangeRuns:B,onChangeTags:C,loading:o,error:u}};export default L;
