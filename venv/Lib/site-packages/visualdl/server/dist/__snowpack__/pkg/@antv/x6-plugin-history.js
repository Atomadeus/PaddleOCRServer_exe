import{h as B,j as S,o as O,k as C,l as E,t as k,m as I,p as P,q as R,r as L,G as f,B as v,g as y,M as N,u as b,v as _}from"../common/html-43a4a009.js";function z(s){var t=s==null?0:s.length;return t?B(s,1):[]}function M(s){return S(O(s,void 0,z),s+"")}function w(s,t,e,n){if(!C(s))return s;t=E(t,s);for(var a=-1,r=t.length,i=r-1,h=s;h!=null&&++a<r;){var o=k(t[a]),c=e;if(o==="__proto__"||o==="constructor"||o==="prototype")return s;if(a!=i){var d=h[o];c=n?n(d,o,h):void 0,c===void 0&&(c=C(d)?d:I(t[a+1])?[]:{})}P(h,o,c),h=h[o]}return s}function G(s,t,e){for(var n=-1,a=t.length,r={};++n<a;){var i=t[n],h=R(s,i);e(h,i)&&w(r,E(i,s),h)}return r}function H(s,t){return G(s,t,function(e,n){return L(s,n)})}var x=M(function(s,t){return s==null?{}:H(s,t)});f.prototype.isHistoryEnabled=function(){const s=this.getPlugin("history");return s?s.isEnabled():!1},f.prototype.enableHistory=function(){const s=this.getPlugin("history");return s&&s.enable(),this},f.prototype.disableHistory=function(){const s=this.getPlugin("history");return s&&s.disable(),this},f.prototype.toggleHistory=function(s){const t=this.getPlugin("history");return t&&t.toggleEnabled(s),this},f.prototype.undo=function(s){const t=this.getPlugin("history");return t&&t.undo(s),this},f.prototype.redo=function(s){const t=this.getPlugin("history");return t&&t.redo(s),this},f.prototype.undoAndCancel=function(s){const t=this.getPlugin("history");return t&&t.cancel(s),this},f.prototype.canUndo=function(){const s=this.getPlugin("history");return s?s.canUndo():!1},f.prototype.canRedo=function(){const s=this.getPlugin("history");return s?s.canRedo():!1},f.prototype.cleanHistory=function(s){const t=this.getPlugin("history");return t&&t.clean(s),this};var A=function(s,t,e,n){var a=arguments.length,r=a<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,e):n,i;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")r=Reflect.decorate(s,t,e,n);else for(var h=s.length-1;h>=0;h--)(i=s[h])&&(r=(a<3?i(r):a>3?i(t,e,r):i(t,e))||r);return a>3&&r&&Object.defineProperty(t,e,r),r};class p extends v{constructor(t){super();this.name="history",this.batchCommands=null,this.batchLevel=0,this.lastBatchIndex=-1,this.freezed=!1,this.handlers=[],this.options=l.getOptions(t),this.validator=new p.Validator({history:this,cancelInvalid:this.options.cancelInvalid})}init(t){this.graph=t,this.model=this.graph.model,this.clean(),this.startListening()}isEnabled(){return!this.disabled}enable(){this.disabled&&(this.options.enabled=!0)}disable(){this.disabled||(this.options.enabled=!1)}toggleEnabled(t){return t!=null?t!==this.isEnabled()&&(t?this.enable():this.disable()):this.isEnabled()?this.disable():this.enable(),this}undo(t={}){if(!this.disabled){const e=this.undoStack.pop();e&&(this.revertCommand(e,t),this.redoStack.push(e),this.notify("undo",e,t))}return this}redo(t={}){if(!this.disabled){const e=this.redoStack.pop();e&&(this.applyCommand(e,t),this.undoStack.push(e),this.notify("redo",e,t))}return this}cancel(t={}){if(!this.disabled){const e=this.undoStack.pop();e&&(this.revertCommand(e,t),this.redoStack=[],this.notify("cancel",e,t))}return this}canUndo(){return!this.disabled&&this.undoStack.length>0}canRedo(){return!this.disabled&&this.redoStack.length>0}clean(t={}){return this.undoStack=[],this.redoStack=[],this.notify("clean",null,t),this}get disabled(){return this.options.enabled!==!0}validate(t,...e){return this.validator.validate(t,...e),this}startListening(){this.model.on("batch:start",this.initBatchCommand,this),this.model.on("batch:stop",this.storeBatchCommand,this),this.options.eventNames&&this.options.eventNames.forEach((t,e)=>{this.handlers[e]=this.addCommand.bind(this,t),this.model.on(t,this.handlers[e])}),this.validator.on("invalid",t=>this.trigger("invalid",t))}stopListening(){this.model.off("batch:start",this.initBatchCommand,this),this.model.off("batch:stop",this.storeBatchCommand,this),this.options.eventNames&&(this.options.eventNames.forEach((t,e)=>{this.model.off(t,this.handlers[e])}),this.handlers.length=0),this.validator.off("invalid")}createCommand(t){return{batch:t?t.batch:!1,data:{}}}revertCommand(t,e){this.freezed=!0;const n=Array.isArray(t)?l.sortBatchCommands(t):[t];for(let a=n.length-1;a>=0;a-=1){const r=n[a],i=Object.assign(Object.assign({},e),x(r.options,this.options.revertOptionsList||[]));this.executeCommand(r,!0,i)}this.freezed=!1}applyCommand(t,e){this.freezed=!0;const n=Array.isArray(t)?l.sortBatchCommands(t):[t];for(let a=0;a<n.length;a+=1){const r=n[a],i=Object.assign(Object.assign({},e),x(r.options,this.options.applyOptionsList||[]));this.executeCommand(r,!1,i)}this.freezed=!1}executeCommand(t,e,n){const a=this.model,r=a.getCell(t.data.id),i=t.event;if(l.isAddEvent(i)&&e||l.isRemoveEvent(i)&&!e)r&&r.remove(n);else if(l.isAddEvent(i)&&!e||l.isRemoveEvent(i)&&e){const h=t.data;h.node?a.addNode(h.props,n):h.edge&&a.addEdge(h.props,n)}else if(l.isChangeEvent(i)){const h=t.data,o=h.key;if(o&&r){const c=e?h.prev[o]:h.next[o];r.prop(o,c,n)}}else{const h=this.options.executeCommand;h&&y(h,this,t,e,n)}}addCommand(t,e){if(this.freezed||this.disabled)return;const n=e,a=n.options||{};if(a.dryrun||l.isAddEvent(t)&&this.options.ignoreAdd||l.isRemoveEvent(t)&&this.options.ignoreRemove||l.isChangeEvent(t)&&this.options.ignoreChange)return;const r=this.options.beforeAddCommand;if(r!=null&&y(r,this,t,e)===!1)return;t==="cell:change:*"&&(t=`cell:change:${n.key}`);const i=n.cell,h=N.isModel(i);let o;if(this.batchCommands){o=this.batchCommands[Math.max(this.lastBatchIndex,0)];const d=h&&!o.modelChange||o.data.id!==i.id,u=o.event!==t;if(this.lastBatchIndex>=0&&(d||u)){const g=this.batchCommands.findIndex(m=>(h&&m.modelChange||m.data.id===i.id)&&m.event===t);g<0||l.isAddEvent(t)||l.isRemoveEvent(t)?o=this.createCommand({batch:!0}):(o=this.batchCommands[g],this.batchCommands.splice(g,1)),this.batchCommands.push(o),this.lastBatchIndex=this.batchCommands.length-1}}else o=this.createCommand({batch:!1});if(l.isAddEvent(t)||l.isRemoveEvent(t)){const d=o.data;return o.event=t,o.options=a,d.id=i.id,d.props=b(i.toJSON()),i.isEdge()?d.edge=!0:i.isNode()&&(d.node=!0),this.push(o,a)}if(l.isChangeEvent(t)){const d=e.key,u=o.data;return(!o.batch||!o.event)&&(o.event=t,o.options=a,u.key=d,u.prev==null&&(u.prev={}),u.prev[d]=b(i.previous(d)),h?o.modelChange=!0:u.id=i.id),u.next==null&&(u.next={}),u.next[d]=b(i.prop(d)),this.push(o,a)}const c=this.options.afterAddCommand;c&&y(c,this,t,e,o),this.push(o,a)}initBatchCommand(t){this.freezed||(this.batchCommands?this.batchLevel+=1:(this.batchCommands=[this.createCommand({batch:!0})],this.batchLevel=0,this.lastBatchIndex=-1))}storeBatchCommand(t){if(!this.freezed)if(this.batchCommands&&this.batchLevel<=0){const e=this.filterBatchCommand(this.batchCommands);e.length>0&&(this.redoStack=[],this.undoStack.push(e),this.consolidateCommands(),this.notify("add",e,t)),this.batchCommands=null,this.lastBatchIndex=-1,this.batchLevel=0}else this.batchCommands&&this.batchLevel>0&&(this.batchLevel-=1)}filterBatchCommand(t){let e=t.slice();const n=[];for(;e.length>0;){const a=e.shift(),r=a.event,i=a.data.id;if(r!=null&&(i!=null||a.modelChange)){if(l.isAddEvent(r)){const h=e.findIndex(o=>l.isRemoveEvent(o.event)&&o.data.id===i);if(h>=0){e=e.filter((o,c)=>h<c||o.data.id!==i);continue}}else if(l.isRemoveEvent(r)){const h=e.findIndex(o=>l.isAddEvent(o.event)&&o.data.id===i);if(h>=0){e.splice(h,1);continue}}else if(l.isChangeEvent(r)){const h=a.data;if(_(h.prev,h.next))continue}n.push(a)}}return n}notify(t,e,n){const a=e==null?null:Array.isArray(e)?e:[e];this.emit(t,{cmds:a,options:n}),this.graph.trigger(`history:${t}`,{cmds:a,options:n}),this.emit("change",{cmds:a,options:n}),this.graph.trigger("history:change",{cmds:a,options:n})}push(t,e){this.redoStack=[],t.batch?(this.lastBatchIndex=Math.max(this.lastBatchIndex,0),this.emit("batch",{cmd:t,options:e})):(this.undoStack.push(t),this.consolidateCommands(),this.notify("add",t,e))}consolidateCommands(){var t;const e=this.undoStack[this.undoStack.length-1],n=this.undoStack[this.undoStack.length-2];if(!Array.isArray(e))return;const a=new Set(e.map(i=>i.event));if(a.size!==2||!a.has("cell:change:parent")||!a.has("cell:change:children")||!e.every(i=>{var h;return i.batch&&((h=i.options)===null||h===void 0?void 0:h.ui)})||!Array.isArray(n)||n.length!==1)return;const r=n[0];r.event!=="cell:change:position"||!((t=r.options)===null||t===void 0?void 0:t.ui)||(n.push(...e),this.undoStack.pop())}dispose(){this.validator.dispose(),this.clean(),this.stopListening(),this.off()}}A([v.dispose()],p.prototype,"dispose",null),function(s){class t extends v{constructor(n){super();this.map={},this.command=n.history,this.cancelInvalid=n.cancelInvalid!==!1,this.command.on("add",this.onCommandAdded,this)}onCommandAdded({cmds:n}){return Array.isArray(n)?n.every(a=>this.isValidCommand(a)):this.isValidCommand(n)}isValidCommand(n){if(n.options&&n.options.validation===!1)return!0;const a=n.event&&this.map[n.event]||[];let r=null;return a.forEach(i=>{let h=0;const o=c=>{const d=i[h];h+=1;try{if(d)d(c,n,o);else{r=c;return}}catch(u){o(u)}};o(r)}),r?(this.cancelInvalid&&this.command.cancel(),this.emit("invalid",{err:r}),!1):!0}validate(n,...a){const r=Array.isArray(n)?n:n.split(/\s+/);return a.forEach(i=>{if(typeof i!="function")throw new Error(`${r.join(" ")} requires callback functions.`)}),r.forEach(i=>{this.map[i]==null&&(this.map[i]=[]),this.map[i].push(a)}),this}dispose(){this.command.off("add",this.onCommandAdded,this)}}A([v.dispose()],t.prototype,"dispose",null),s.Validator=t}(p||(p={}));var l;(function(s){function t(i){return i==="cell:added"}s.isAddEvent=t;function e(i){return i==="cell:removed"}s.isRemoveEvent=e;function n(i){return i!=null&&i.startsWith("cell:change:")}s.isChangeEvent=n;function a(i){const h=["cell:added","cell:removed","cell:change:*"],o=["batch:start","batch:stop"],c=i.eventNames?i.eventNames.filter(d=>!(s.isChangeEvent(d)||h.includes(d)||o.includes(d))):h;return Object.assign(Object.assign({},i),{eventNames:c,applyOptionsList:i.applyOptionsList||["propertyPath"],revertOptionsList:i.revertOptionsList||["propertyPath"]})}s.getOptions=a;function r(i){const h=[];for(let o=0,c=i.length;o<c;o+=1){const d=i[o];let u=null;if(s.isAddEvent(d.event)){const g=d.data.id;for(let m=0;m<o;m+=1)if(i[m].data.id===g){u=m;break}}u!==null?h.splice(u,0,d):h.push(d)}return h}s.sortBatchCommands=r})(l||(l={}));export{p as History};
