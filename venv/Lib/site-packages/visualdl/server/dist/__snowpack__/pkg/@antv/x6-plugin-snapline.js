import{y as _,V as D,g as $,A as H,s as X,f as Y,z as j,G as y,w as G,F as k,J as K}from"../common/html-43a4a009.js";var Q=function(i,t,e,n){var s=arguments.length,o=s<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,e):n,l;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(i,t,e,n);else for(var c=i.length-1;c>=0;c--)(l=i[c])&&(o=(s<3?l(o):s>3?l(t,e,o):l(t,e))||o);return s>3&&o&&Object.defineProperty(t,e,o),o},U=function(i,t){var e={};for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&t.indexOf(n)<0&&(e[n]=i[n]);if(i!=null&&typeof Object.getOwnPropertySymbols=="function")for(var s=0,n=Object.getOwnPropertySymbols(i);s<n.length;s++)t.indexOf(n[s])<0&&Object.prototype.propertyIsEnumerable.call(i,n[s])&&(e[n[s]]=i[n[s]]);return e};class F extends _{constructor(t){super();const{graph:e}=t,n=U(t,["graph"]);this.graph=e,this.options=Object.assign({tolerance:10},n),this.offset={x:0,y:0},this.render(),this.disabled||this.startListening()}get model(){return this.graph.model}get containerClassName(){return this.prefixClassName("widget-snapline")}get verticalClassName(){return`${this.containerClassName}-vertical`}get horizontalClassName(){return`${this.containerClassName}-horizontal`}get disabled(){return this.options.enabled!==!0}enable(){this.disabled&&(this.options.enabled=!0,this.startListening())}disable(){this.disabled||(this.options.enabled=!1,this.stopListening())}setFilter(t){this.options.filter=t}render(){const t=this.containerWrapper=new D("svg"),e=this.horizontal=new D("line"),n=this.vertical=new D("line");t.addClass(this.containerClassName),e.addClass(this.horizontalClassName),n.addClass(this.verticalClassName),t.setAttribute("width","100%"),t.setAttribute("height","100%"),e.setAttribute("display","none"),n.setAttribute("display","none"),t.append([e,n]),this.options.className&&t.addClass(this.options.className),this.container=this.containerWrapper.node}startListening(){this.stopListening(),this.graph.on("node:mousedown",this.captureCursorOffset,this),this.graph.on("node:mousemove",this.snapOnMoving,this),this.model.on("batch:stop",this.onBatchStop,this),this.delegateDocumentEvents({mouseup:"hide",touchend:"hide"})}stopListening(){this.graph.off("node:mousedown",this.captureCursorOffset,this),this.graph.off("node:mousemove",this.snapOnMoving,this),this.model.off("batch:stop",this.onBatchStop,this),this.undelegateDocumentEvents()}onBatchStop({name:t,data:e}){t==="resize"&&this.snapOnResizing(e.cell,e)}captureCursorOffset({view:t,x:e,y:n}){const s=t.getDelegatedView();if(s&&this.isNodeMovable(s)){const o=t.cell.getPosition();this.offset={x:e-o.x,y:n-o.y}}}isNodeMovable(t){return t&&t.cell.isNode()&&t.can("nodeMovable")}getRestrictArea(t){const e=this.graph.options.translating.restrict,n=typeof e=="function"?$(e,this.graph,t):e;return typeof n=="number"?this.graph.transform.getGraphArea().inflate(n):n===!0?this.graph.transform.getGraphArea():n||null}snapOnResizing(t,e){if(this.options.resizing&&!e.snapped&&e.ui&&e.direction&&e.trueDirection){const n=this.graph.renderer.findViewByCell(t);if(n&&n.cell.isNode()){const s=t.getBBox(),o=s.bbox(t.getAngle()),l=o.getTopLeft(),c=o.getBottomRight(),v=H.normalize(t.getAngle()),C=this.options.tolerance||0;let u,P,O,r,R,x;const p={vertical:0,horizontal:0},L=e.direction,B=e.trueDirection,d=e.relativeDirection;B.indexOf("right")!==-1?p.vertical=c.x:p.vertical=l.x,B.indexOf("bottom")!==-1?p.horizontal=c.y:p.horizontal=l.y,this.model.getNodes().some(a=>{if(this.isIgnored(t,a))return!1;const g=a.getBBox().bbox(a.getAngle()),T=g.getTopLeft(),E=g.getBottomRight(),W={vertical:[T.x,E.x],horizontal:[T.y,E.y]},I={};return Object.keys(W).forEach(q=>{const N=q,J=W[N].map(A=>({position:A,distance:Math.abs(A-p[N])})).filter(A=>A.distance<=C);I[N]=X(J,A=>A.distance)}),u==null&&I.vertical.length>0&&(u=I.vertical[0].position,P=Math.min(o.y,g.y),O=Math.max(c.y,E.y)-P),r==null&&I.horizontal.length>0&&(r=I.horizontal[0].position,R=Math.min(o.x,g.x),x=Math.max(c.x,E.x)-R),u!=null&&r!=null}),this.hide();let z=0,b=0;(r!=null||u!=null)&&(u!=null&&(z=B.indexOf("right")!==-1?u-c.x:l.x-u),r!=null&&(b=B.indexOf("bottom")!==-1?r-c.y:l.y-r));let M=0,w=0;if(v%90==0)v===90||v===270?(M=b,w=z):(M=z,w=b);else{const a=v>=0&&v<90?1:v>=90&&v<180?4:v>=180&&v<270?3:2;r!=null&&u!=null&&(z<b?(b=0,r=void 0):(z=0,u=void 0));const g=H.toRad(v%90);z&&(M=a===3?z/Math.cos(g):z/Math.sin(g)),b&&(w=a===3?b/Math.cos(g):b/Math.sin(g));const T=a===1||a===3;switch(d){case"top":case"bottom":w=b?b/(T?Math.cos(g):Math.sin(g)):z/(T?Math.sin(g):Math.cos(g));break;case"left":case"right":M=z?z/(T?Math.cos(g):Math.sin(g)):b/(T?Math.sin(g):Math.cos(g));break}}switch(d){case"top":case"bottom":M=0;break;case"left":case"right":w=0;break}const S=this.graph.getGridSize();let f=Math.max(s.width+M,S),m=Math.max(s.height+w,S);e.minWidth&&e.minWidth>S&&(f=Math.max(f,e.minWidth)),e.minHeight&&e.minHeight>S&&(m=Math.max(m,e.minHeight)),e.maxWidth&&(f=Math.min(f,e.maxWidth)),e.maxHeight&&(m=Math.min(m,e.maxHeight)),e.preserveAspectRatio&&(w<M?m=f*(s.height/s.width):f=m*(s.width/s.height)),(f!==s.width||m!==s.height)&&(t.resize(f,m,{direction:L,relativeDirection:d,trueDirection:B,snapped:!0,snaplines:this.cid,restrict:this.getRestrictArea(n)}),O&&(O+=m-s.height),x&&(x+=f-s.width));const h=t.getBBox().bbox(v);u&&Math.abs(h.x-u)>1&&Math.abs(h.width+h.x-u)>1&&(u=void 0),r&&Math.abs(h.y-r)>1&&Math.abs(h.height+h.y-r)>1&&(r=void 0),this.update({verticalLeft:u,verticalTop:P,verticalHeight:O,horizontalTop:r,horizontalLeft:R,horizontalWidth:x})}}}snapOnMoving({view:t,e,x:n,y:s}){const o=t.getEventData(e).delegatedView||t;if(!this.isNodeMovable(o))return;const l=o.cell,c=l.getSize(),v=l.getPosition(),C=new Y(n-this.offset.x,s-this.offset.y,c.width,c.height),u=l.getAngle(),P=C.getCenter(),O=C.bbox(u),r=O.getTopLeft(),R=O.getBottomRight(),x=this.options.tolerance||0;let p,L,B,d,z,b,M=0,w=0;if(this.model.getNodes().some(S=>{if(this.isIgnored(l,S))return!1;const f=S.getBBox().bbox(S.getAngle()),m=f.getCenter(),h=f.getTopLeft(),a=f.getBottomRight();return p==null&&(Math.abs(m.x-P.x)<x?(p=m.x,M=.5):Math.abs(h.x-r.x)<x?(p=h.x,M=0):Math.abs(h.x-R.x)<x?(p=h.x,M=1):Math.abs(a.x-R.x)<x?(p=a.x,M=1):Math.abs(a.x-r.x)<x&&(p=a.x),p!=null&&(L=Math.min(O.y,f.y),B=Math.max(R.y,a.y)-L)),d==null&&(Math.abs(m.y-P.y)<x?(d=m.y,w=.5):Math.abs(h.y-r.y)<x?d=h.y:Math.abs(h.y-R.y)<x?(d=h.y,w=1):Math.abs(a.y-R.y)<x?(d=a.y,w=1):Math.abs(a.y-r.y)<x&&(d=a.y),d!=null&&(z=Math.min(O.x,f.x),b=Math.max(R.x,a.x)-z)),p!=null&&d!=null}),this.hide(),d!=null||p!=null){d!=null&&(O.y=d-w*O.height),p!=null&&(O.x=p-M*O.width);const S=O.getCenter(),f=S.x-C.width/2,m=S.y-C.height/2,h=f-v.x,a=m-v.y;(h!==0||a!==0)&&(l.translate(h,a,{snapped:!0,restrict:this.getRestrictArea(o)}),b&&(b+=h),B&&(B+=a)),this.update({verticalLeft:p,verticalTop:L,verticalHeight:B,horizontalTop:d,horizontalLeft:z,horizontalWidth:b})}}isIgnored(t,e){return e.id===t.id||e.isDescendantOf(t)||!this.filter(e)}filter(t){const e=this.options.filter;return Array.isArray(e)?e.some(n=>typeof n=="string"?t.shape===n:t.id===n.id):typeof e=="function"?$(e,this.graph,t):!0}update(t){if(t.horizontalTop){const e=this.graph.localToGraph(new j(t.horizontalLeft,t.horizontalTop)),n=this.graph.localToGraph(new j(t.horizontalLeft+t.horizontalWidth,t.horizontalTop));this.horizontal.setAttributes({x1:this.options.sharp?`${e.x}`:"0",y1:`${e.y}`,x2:this.options.sharp?`${n.x}`:"100%",y2:`${n.y}`,display:"inherit"})}else this.horizontal.setAttribute("display","none");if(t.verticalLeft){const e=this.graph.localToGraph(new j(t.verticalLeft,t.verticalTop)),n=this.graph.localToGraph(new j(t.verticalLeft,t.verticalTop+t.verticalHeight));this.vertical.setAttributes({x1:`${e.x}`,y1:this.options.sharp?`${e.y}`:"0",x2:`${n.x}`,y2:this.options.sharp?`${n.y}`:"100%",display:"inherit"})}else this.vertical.setAttribute("display","none");this.show()}resetTimer(){this.timer&&(clearTimeout(this.timer),this.timer=null)}show(){return this.resetTimer(),this.container.parentNode==null&&this.graph.container.appendChild(this.container),this}hide(){this.resetTimer(),this.vertical.setAttribute("display","none"),this.horizontal.setAttribute("display","none");const t=this.options.clean,e=typeof t=="number"?t:t!==!1?3e3:0;return e>0&&(this.timer=window.setTimeout(()=>{this.container.parentNode!==null&&this.unmount()},e)),this}onRemove(){this.stopListening(),this.hide()}dispose(){this.remove()}}Q([_.dispose()],F.prototype,"dispose",null);const Z=`.x6-widget-snapline {
  position: absolute;
  top: 0;
  right: 0;
  bottom: 0;
  left: 0;
  pointer-events: none;
}
.x6-widget-snapline-vertical,
.x6-widget-snapline-horizontal {
  stroke: #2ecc71;
  stroke-width: 1px;
}
`;y.prototype.isSnaplineEnabled=function(){const i=this.getPlugin("snapline");return i?i.isEnabled():!1},y.prototype.enableSnapline=function(){const i=this.getPlugin("snapline");return i&&i.enable(),this},y.prototype.disableSnapline=function(){const i=this.getPlugin("snapline");return i&&i.disable(),this},y.prototype.toggleSnapline=function(){const i=this.getPlugin("snapline");return i&&i.toggleEnabled(),this},y.prototype.hideSnapline=function(){const i=this.getPlugin("snapline");return i&&i.hide(),this},y.prototype.setSnaplineFilter=function(i){const t=this.getPlugin("snapline");return t&&t.setFilter(i),this},y.prototype.isSnaplineOnResizingEnabled=function(){const i=this.getPlugin("snapline");return i?i.isOnResizingEnabled():!1},y.prototype.enableSnaplineOnResizing=function(){const i=this.getPlugin("snapline");return i&&i.enableOnResizing(),this},y.prototype.disableSnaplineOnResizing=function(){const i=this.getPlugin("snapline");return i&&i.disableOnResizing(),this},y.prototype.toggleSnaplineOnResizing=function(i){const t=this.getPlugin("snapline");return t&&t.toggleOnResizing(i),this},y.prototype.isSharpSnapline=function(){const i=this.getPlugin("snapline");return i?i.isSharp():!1},y.prototype.enableSharpSnapline=function(){const i=this.getPlugin("snapline");return i&&i.enableSharp(),this},y.prototype.disableSharpSnapline=function(){const i=this.getPlugin("snapline");return i&&i.disableSharp(),this},y.prototype.toggleSharpSnapline=function(i){const t=this.getPlugin("snapline");return t&&t.toggleSharp(i),this},y.prototype.getSnaplineTolerance=function(){const i=this.getPlugin("snapline");if(i)return i.getTolerance()},y.prototype.setSnaplineTolerance=function(i){const t=this.getPlugin("snapline");return t&&t.setTolerance(i),this};var tt=function(i,t,e,n){var s=arguments.length,o=s<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,e):n,l;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(i,t,e,n);else for(var c=i.length-1;c>=0;c--)(l=i[c])&&(o=(s<3?l(o):s>3?l(t,e,o):l(t,e))||o);return s>3&&o&&Object.defineProperty(t,e,o),o};class V extends G{constructor(t){super();this.options=t,this.name="snapline",k(this.name,Z)}init(t){this.snaplineImpl=new F(Object.assign(Object.assign({},this.options),{graph:t}))}isEnabled(){return!this.snaplineImpl.disabled}enable(){return this.snaplineImpl.enable(),this}disable(){return this.snaplineImpl.disable(),this}toggleEnabled(t){if(t!=null)t!==this.isEnabled()&&(t?this.enable():this.disable());else return this.isEnabled()?this.disable():this.enable(),this}hide(){return this.snaplineImpl.hide(),this}setFilter(t){return this.snaplineImpl.setFilter(t),this}isOnResizingEnabled(){return this.snaplineImpl.options.resizing===!0}enableOnResizing(){return this.snaplineImpl.options.resizing=!0,this}disableOnResizing(){return this.snaplineImpl.options.resizing=!1,this}toggleOnResizing(t){return t!=null?t!==this.isOnResizingEnabled()&&(t?this.enableOnResizing():this.disableOnResizing()):this.isOnResizingEnabled()?this.disableOnResizing():this.enableOnResizing(),this}isSharp(){return this.snaplineImpl.options.sharp===!0}enableSharp(){return this.snaplineImpl.options.sharp=!0,this}disableSharp(){return this.snaplineImpl.options.sharp=!1,this}toggleSharp(t){return t!=null?t!==this.isSharp()&&(t?this.enableSharp():this.disableSharp()):this.isSharp()?this.disableSharp():this.enableSharp(),this}getTolerance(){return this.snaplineImpl.options.tolerance}setTolerance(t){return this.snaplineImpl.options.tolerance=t,this}captureCursorOffset(t){this.snaplineImpl.captureCursorOffset(t)}snapOnMoving(t){this.snaplineImpl.snapOnMoving(t)}dispose(){this.snaplineImpl.dispose(),K(this.name)}}tt([G.dispose()],V.prototype,"dispose",null);export{V as Snapline};
