var caffe=caffe||{},long=long||{Long:require("long")},protobuf=protobuf||require("./protobuf");caffe.ModelFactory=class{match(t){const e=t.identifier,a=e.split(".").pop().toLowerCase();if("caffemodel"==a)return!0;if("pbtxt"==a||"prototxt"==a){if("saved_model.pbtxt"==e||"saved_model.prototxt"==e||e.endsWith("predict_net.pbtxt")||e.endsWith("predict_net.prototxt")||e.endsWith("init_net.pbtxt")||e.endsWith("init_net.prototxt"))return!1;const a=t.tags("pbtxt");if(a.has("layer")||a.has("layers")||a.has("net")||a.has("train_net")||a.has("net_param"))return!0}if("pt"==a){const e=t.buffer,a=[138,10,108,252,156,70,249,32,106,168,80,25];if(e&&e.length>14&&128==e[0]&&a.every(((t,a)=>t==e[a+2])))return!1;if(e&&e.length>2&&80==e[0]&&75==e[1])return!1;const n=t.tags("pbtxt");if(n.has("layer")||n.has("layers")||n.has("net")||n.has("train_net")||n.has("net_param"))return!0}return!1}open(t,e){return e.require("./caffe-proto").then((()=>(caffe.proto=protobuf.get("caffe").caffe,caffe.Metadata.open(e).then((a=>{const n=t.identifier.split(".").pop();if("pbtxt"==n||"prototxt"==n||"pt"==n){const n=t.tags("pbtxt");if(n.has("net")||n.has("train_net")||n.has("net_param"))try{const n=protobuf.TextReader.create(t.text);n.field=function(t,e){if(!(e instanceof caffe.proto.SolverParameter))throw new Error("Unknown field '"+t+"'"+this.location());e[t]=this.skip()};const r=caffe.proto.SolverParameter.decodeText(n);if(r.net_param)return this._openNetParameter(a,r.net_param,e);if(r.net||r.train_net){let n=r.net||r.train_net;return n=n.split("/").pop(),t.request(n,"utf-8").then((n=>this._openNetParameterText(a,t.identifier,n,e))).catch((t=>{if(t){const e=t&&t.message?t.message:t.toString();throw new caffe.Error("Failed to load '"+n+"' ("+e.replace(/\.$/,"")+").")}}))}}catch(t){}return this._openNetParameterText(a,t.identifier,t.text,e)}return this._openNetParameterBuffer(a,t.identifier,t.buffer,e)})))))}_openNetParameterBuffer(t,e,a,n,r,s){try{const e=protobuf.Reader.create(a),i=caffe.proto.NetParameter.decode(e);return this._openNetParameter(t,i,n,r,s)}catch(t){throw new caffe.Error("File format is not caffe.NetParameter ("+t.message+") in '"+e+"'.")}}_openNetParameterText(t,e,a,n){try{const e=protobuf.TextReader.create(a);e.field=function(t,a){const n=a.constructor.name;if(!t.endsWith("_param")||"LayerParameter"!=n&&"V1LayerParameter"!=n&&"V0LayerParameter"!=n){if(!a.constructor.name.endsWith("Parameter")&&"ParamSpec"!==a.constructor.name)throw new Error("Unknown field '"+t+"'"+this.location());a[t]?(Array.isArray(a[t])||(a[t]=[a[t]]),a[t].push(this.skip())):a[t]=this.skip()}else a[t]=caffe.ModelFactory._decodeText(e)},e.enum=function(t){const e=this.read();if(!Object.prototype.hasOwnProperty.call(t,e)){const t=Number.parseInt(e,10);return Number.isNaN(e-t)?e:t}return t[e]};const r=caffe.proto.NetParameter.decodeText(e);return this._openNetParameter(t,r,n)}catch(t){throw new caffe.Error("File text format is not caffe.NetParameter ("+t.message+") in '"+e+"'.")}}_openNetParameter(t,e,a){try{return new caffe.Model(t,e)}catch(t){throw a.exception(t,!1),new caffe.Error(t.message)}}static _decodeText(t){const e={};for(t.start();!t.end();){const a=t.tag(),n=t.skip();e[a]?(Array.isArray(e[a])||(e[a]=[e[a]]),e[a].push(n)):e[a]=n}return e}},caffe.Model=class{constructor(t,e){this._name=e.name,e.layers&&e.layers.length>0?e.layers.every((t=>Object.prototype.hasOwnProperty.call(t,"layer")))?(this._version=0,e.layer=e.layers):(this._version=1,e.layer=e.layers):e.layer&&e.layer.length>0&&(this._version=2),this._graphs=[];const a=new Set;for(const t of e.layer)for(const e of t.include)void 0!==e.phase&&a.add(e.phase);0===a.size&&a.add(-1);for(const n of a)this._graphs.push(new caffe.Graph(t,n,e,this._version))}get format(){return"Caffe"+(this._version?" v"+this._version.toString():"")}get graphs(){return this._graphs}},caffe.Graph=class{constructor(t,e,a,n){switch(e){case 0:this._phase="TRAIN";break;case 1:this._phase="TEST";break;case-1:this._phase="";break;default:this._phase=e.toString()}this._nodes=[],this._inputs=[],this._outputs=[];for(const t of a.layer)t.input=t.bottom.slice(0),t.output=t.top.slice(0),t.chain=[];const r=[];for(const t of a.layer)(-1===e||t.include.every((t=>t.phase===e)))&&r.push(t);const s={};let i=0;for(const t of r)t.input=t.input.map((t=>s[t]?s[t]:t)),t.output=t.output.map((t=>(s[t]=s[t]?t+"\n"+i.toString():t,s[t]))),i++;const o=new Set;for(const t of r)for(const e of t.output)o.add(e);const c=[];for(const t of r)for(const e of t.input)o.has(e)||c.push(e);const u=[];let p=null,f=null;for(;r.length>0;){let t=r.shift();if(1==t.output.length&&1==t.input.length&&t.output[0].split("\n").shift()==t.input[0].split("\n").shift()&&p&&f==t.output[0].split("\n").shift())p.chain=p.chain||[],p.chain.push(t);else{if(("Input"==t.type||"Data"==t.type)&&0==t.input.length&&1==t.output.length&&t.input_param&&t.input_param.shape&&1==t.input_param.shape.length&&t.input_param.shape[0].dim){const e=new caffe.TensorType(null,new caffe.TensorShape(t.input_param.shape[0].dim));this._inputs.push(new caffe.Parameter(t.output[0],[new caffe.Argument(t.output[0],e)])),t=null}t&&(u.push(t),p=null,f=null,1==t.output.length&&(p=t,f=t.output[0].split("\n").shift()))}}if(a.input)for(let t=0;t<a.input.length;t++){const e=a.input[t];if(this._inputs.some((t=>t.name===e)))continue;let n=null;if(a.input_shape&&t<a.input_shape.length){const e=a.input_shape[t];e&&e.dim&&(n=new caffe.TensorType(null,new caffe.TensorShape(e.dim)))}const r=4*t;!n&&a.input_dim&&a.input_dim.length>=r&&(n=new caffe.TensorType(null,new caffe.TensorShape(a.input_dim.slice(r,r+4)))),this._inputs.push(new caffe.Parameter(e,[new caffe.Argument(e,n,null)]))}for(const e of u){const a=new caffe.Node(t,e,n);if(e.chain&&e.chain.length>0)for(const r of e.chain)a.chain.push(new caffe.Node(t,r,n));this._nodes.push(a)}0===this._inputs.length&&1===c.length&&this._inputs.push(new caffe.Parameter(c[0],[new caffe.Argument(c[0],null)]))}get name(){return this._phase}get type(){return""}get inputs(){return this._inputs}get outputs(){return this._outputs}get nodes(){return this._nodes}},caffe.Parameter=class{constructor(t,e){this._name=t,this._arguments=e}get name(){return this._name}get visible(){return!0}get arguments(){return this._arguments}},caffe.Argument=class{constructor(t,e,a){if("string"!=typeof t)throw new caffe.Error("Invalid argument identifier '"+JSON.stringify(t)+"'.");this._name=t,this._type=e||null,this._initializer=a||null}get name(){return this._name}get type(){return this._type}get initializer(){return this._initializer}},caffe.Node=class{constructor(t,e,a){switch(this._metadata=t,this._chain=[],this._attributes=[],a){case 0:this._name=e.layer.name,this._type=e.layer.type;break;case 1:{this._name=e.name;const t=e.type;if(void 0===t)this._type="?";else{if(!caffe.Node._typeMap){caffe.Node._typeMap={};const t={BNLL:"BNLL",HDF5:"HDF5",LRN:"LRN",RELU:"ReLU",TANH:"TanH",ARGMAX:"ArgMax",MVN:"MVN",ABSVAL:"AbsVal"};for(const e of Object.keys(caffe.proto.V1LayerParameter.LayerType)){const a=caffe.proto.V1LayerParameter.LayerType[e];caffe.Node._typeMap[a]=e.split("_").map((e=>t[e]||e.substring(0,1)+e.substring(1).toLowerCase())).join("")}}this._type=caffe.Node._typeMap[t]||t.toString()}break}case 2:this._name=e.name,this._type=e.type}let n=[];switch(a){case 0:for(const a of Object.keys(e.layer))"type"!=a&&"name"!=a&&"blobs"!=a&&"blobs_lr"!=a&&this._attributes.push(new caffe.Attribute(t.attribute(this.type,a),a,e.layer[a]));n=e.layer.blobs.map((t=>new caffe.Tensor(t)));break;case 1:case 2:for(const a of Object.keys(e))if(a.endsWith("_param")||"transform_param"==a){const n=e[a];let r=this._type;"Deconvolution"==r&&(r="Convolution");const s=Object.getPrototypeOf(n);for(const e of Object.keys(n)){const a=s[e],r=n[e];r==a||Array.isArray(r)&&Array.isArray(a)&&0==r.length&&0==a.length||this._attributes.push(new caffe.Attribute(t.attribute(this.type,e),e,r))}}e.include&&e.include.length>0&&this._attributes.push(new caffe.Attribute(this._metadata.attribute(this.type,"include"),"include",e.include)),e.exclude&&e.exclude.length>0&&this._attributes.push(new caffe.Attribute(this._metadata.attribute(this.type,"exclude"),"exclude",e.exclude)),"Data"==this._type&&e.input_param&&e.input_param.shape&&this._attributes.push(new caffe.Attribute(this._metadata.attribute(this.type,"shape"),"shape",e.input_param.shape)),n=e.blobs.map((t=>new caffe.Tensor(t)))}const r=this._metadata.type(this.type);this._inputs=[];const s=e.input.concat(n);let i=0;if(r&&r.inputs)for(const t of r.inputs)if(i<s.length||"optional"!=t.option){const e="variadic"==t.option?s.length-i:1;this._inputs.push(new caffe.Parameter(t.name,s.slice(i,i+e).filter((e=>""!==e||"optional"!=t.option)).map((t=>t instanceof caffe.Tensor?new caffe.Argument("",t.type,t):new caffe.Argument(t,null,null))))),i+=e}this._inputs=this._inputs.concat(s.slice(i).map((t=>new caffe.Parameter(i.toString(),[t instanceof caffe.Tensor?new caffe.Argument("",t.type,t):new caffe.Argument(t,null,null)])))),this._outputs=[];const o=e.output;let c=0;if(r&&r.outputs)for(const t of r.outputs)if(c<o.length){const e="variadic"==t.option?o.length-c:1;this._outputs.push(new caffe.Parameter(t.name,o.slice(c,c+e).map((t=>new caffe.Argument(t,null,null))))),c+=e}this._outputs=this._outputs.concat(o.slice(c).map(((t,e)=>new caffe.Parameter((c+e).toString(),[new caffe.Argument(t,null,null)]))))}get type(){return this._type}get metadata(){return this._metadata.type(this._type)}get name(){return this._name}get inputs(){return this._inputs}get outputs(){return this._outputs}get attributes(){return this._attributes}get chain(){return this._chain}},caffe.Attribute=class{constructor(t,e,a){if(this._name=e,this._value=a,a instanceof caffe.proto.BlobShape&&(this._value=new caffe.TensorShape(a.dim)),t)if(Object.prototype.hasOwnProperty.call(t,"visible")&&!t.visible)this._visible=!1;else if(Object.prototype.hasOwnProperty.call(t,"default")){const e=t.default;(this._value==e||Array.isArray(this._value)&&Array.isArray(e)&&this._value.length==e.length&&this._value.every(((t,a)=>t==e[a])))&&(this._visible=!1)}}get name(){return this._name}get value(){return this._value}get visible(){return 0!=this._visible}},caffe.Tensor=class{constructor(t){this._blob=t;let e=[];Object.prototype.hasOwnProperty.call(t,"num")&&Object.prototype.hasOwnProperty.call(t,"channels")&&Object.prototype.hasOwnProperty.call(t,"width")&&Object.prototype.hasOwnProperty.call(t,"height")?(1!=t.num&&e.push(t.num),1!=t.channels&&e.push(t.channels),1!=t.width&&e.push(t.width),1!=t.height&&e.push(t.height)):Object.prototype.hasOwnProperty.call(t,"shape")&&(e=t.shape.dim);let a="?";t.data.length>0?(a="float32",this._data=t.data):t.double_data.length>0&&(a="float64",this._data=t.double_data),this._type=new caffe.TensorType(a,new caffe.TensorShape(e))}get kind(){return"Blob"}get type(){return this._type}get state(){return this._context().state}get value(){const t=this._context();return t.state?null:(t.limit=Number.MAX_SAFE_INTEGER,this._decode(t,0))}toString(){const t=this._context();if(t.state)return"";t.limit=1e4;const e=this._decode(t,0);return JSON.stringify(e,null,4)}_context(){const t={state:null,index:0,count:0};return t.data=this._data,t.dimensions=this.type.shape.dimensions,this._data||(t.state="Tensor data is empty."),t}_decode(t,e){const a=[],n=t.dimensions[e];if(e==t.dimensions.length-1)for(let e=0;e<n;e++){if(t.count>t.limit)return a.push("..."),a;a.push(t.data[t.index]),t.index++,t.count++}else for(let r=0;r<n;r++){if(t.count>t.limit)return a.push("..."),a;a.push(this._decode(t,e+1))}return a}},caffe.TensorType=class{constructor(t,e){this._dataType=t,this._shape=e}get dataType(){return this._dataType}get shape(){return this._shape}toString(){return(this.dataType||"?")+this._shape.toString()}},caffe.TensorShape=class{constructor(t){this._dimensions=t.map((t=>t&&long.Long.isLong(t)?t.toNumber():t))}get dimensions(){return this._dimensions}toString(){return this._dimensions?"["+this._dimensions.map((t=>t.toString())).join(",")+"]":""}},caffe.Metadata=class{static open(t){return caffe.Metadata._metadata?Promise.resolve(caffe.Metadata._metadata):t.request(null,"caffe-metadata.json","utf-8").then((t=>(caffe.Metadata._metadata=new caffe.Metadata(t),caffe.Metadata._metadata))).catch((()=>(caffe.Metadata._metadata=new caffe.Metadata(null),caffe.Metadata._metadata)))}constructor(t){if(this._map={},this._attributeCache={},t){const e=JSON.parse(t);if(e)for(const t of e)t.name&&t.schema&&(t.schema.name=t.name,this._map[t.name]=t.schema)}}type(t){return this._map[t]||null}attribute(t,e){let a=this._attributeCache[t];if(!a){a={};const e=this.type(t);if(e&&e.attributes&&e.attributes.length>0)for(const t of e.attributes)a[t.name]=t;this._attributeCache[t]=a}return a[e]||null}},caffe.Error=class extends Error{constructor(t){super(t),this.name="Error loading Caffe model."}},"undefined"!=typeof module&&"object"==typeof module.exports&&(module.exports.ModelFactory=caffe.ModelFactory);